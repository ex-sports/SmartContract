const {
    Client, CryptoUtils, LoomProvider, LocalAddress
  } = require("loom-js");

const { readFileSync } = require('fs');
var ethers = require('ethers');

const LoomInfo = require('./truffle-config.js');
const LoomTruffleProvider = require('loom-truffle-provider');
// Node.JS 8 또는 이후버전
const Web3 = require("web3");


const loomProvider = LoomInfo.getLoomMainnetProvider();








const web3 = new Web3(loomProvider);

let provider = new ethers.providers.Web3Provider(web3.currentProvider);
var wallet = provider.getSigner();

var coinAddress  = '0xeA4aEe8AdC6577a05901D7958Ca9A975B9dD92AA';
var coinABI =
[{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"gogo","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isOwner","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"coreAddr","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_base","type":"address"}],"name":"NewCoreSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_amount","type":"uint256"},{"indexed":false,"name":"_purchaseId","type":"string"},{"indexed":false,"name":"_memo","type":"string"}],"name":"PurchaseCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"},{"indexed":false,"name":"_memo","type":"string"}],"name":"RewardCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"},{"indexed":false,"name":"_memo","type":"string"}],"name":"SendCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"},{"indexed":false,"name":"_memo","type":"string"}],"name":"BurnCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_buyer","type":"address"},{"indexed":false,"name":"_amount","type":"uint256"},{"indexed":false,"name":"_purchaseId","type":"string"},{"indexed":false,"name":"_memo","type":"string"}],"name":"PurchaseCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"},{"indexed":false,"name":"_memo","type":"string"}],"name":"RewardCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_owner","type":"address"},{"indexed":false,"name":"_value","type":"uint256"},{"indexed":false,"name":"_memo","type":"string"}],"name":"BurnCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"previousOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"constant":false,"inputs":[{"name":"_coreAddr","type":"address"}],"name":"setCoreAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getCoreAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"},{"name":"_purchaseId","type":"string"},{"name":"_memo","type":"string"}],"name":"purchaseCoin","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"},{"name":"_memo","type":"string"}],"name":"rewardCoin","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"},{"name":"_memo","type":"string"}],"name":"sendCoin","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"},{"name":"_memo","type":"string"}],"name":"burnCoin","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}];

var tokenAddress = '0x5F87725c409e6B82e1765554AFCBa8808A437aE2';
var tokenABI =
[{"constant":true,"inputs":[{"name":"_address","type":"address"},{"name":"_tokenId","type":"uint256"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_amount","type":"uint256"}],"name":"transfer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_amount","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"implementsERC721","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenIds","type":"uint256[]"},{"name":"_amounts","type":"uint256[]"}],"name":"batchTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"tokensOwned","outputs":[{"name":"indexes","type":"uint256[]"},{"name":"balances","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenIds","type":"uint256[]"},{"name":"_amounts","type":"uint256[]"},{"name":"_data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"name":"_tokenId","type":"uint256"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_tokenId","type":"uint256"}],"name":"exists","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"implementsERC721X","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[{"name":"_operator","type":"address"},{"name":"_approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"marketAddr","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"tradeAddr","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"name":"isOperator","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_amount","type":"uint256"},{"name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_amount","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_baseTokenURI","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_baseTokenURI","type":"string"}],"name":"NewBaseTokenURI","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_addr","type":"address"}],"name":"NewMarketAddress","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_addr","type":"address"}],"name":"NewTradeAddress","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"address"},{"indexed":false,"name":"to","type":"address"},{"indexed":false,"name":"tokenTypes","type":"uint256[]"},{"indexed":false,"name":"amounts","type":"uint256[]"}],"name":"BatchTransfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":true,"name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"approved","type":"address"},{"indexed":true,"name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"operator","type":"address"},{"indexed":false,"name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":true,"name":"tokenId","type":"uint256"},{"indexed":false,"name":"quantity","type":"uint256"}],"name":"TransferWithQuantity","type":"event"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_baseTokenURI","type":"string"}],"name":"setBaseTokenURI","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getBaseTokenURI","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"setMarketAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getMarketAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"setTradeAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getTradeAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_operator","type":"address"},{"name":"approval","type":"bool"}],"name":"setOperator","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_tokenId","type":"uint256"},{"name":"_to","type":"address"},{"name":"_supply","type":"uint256"}],"name":"mint","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"totalBalanceOf","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_totalQuantity","type":"uint256"},{"name":"_perPrice","type":"uint256"}],"name":"registerServiceProduct","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_quantity","type":"uint256"},{"name":"_price","type":"uint256"}],"name":"registerUserProduct","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_offerTokenIds","type":"uint256[]"},{"name":"_offerTokenAmounts","type":"uint256[]"},{"name":"_requiredTokenIds","type":"uint256[]"},{"name":"_requiredTokenAmounts","type":"uint256[]"}],"name":"registerTradeProduct","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"}];


var marketAddress = '0x278a73c792AC6D6ac7C3511008d880C8f4be1732';
var marketABI = [{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"allServiceProducts","outputs":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"totalAmount","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"perPrice","type":"uint256"},{"name":"isValid","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"allUserProducts","outputs":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"isValid","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"tokenContract","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"coinContract","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isOwner","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"validUserProductIds","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"validServiceProductIds","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_coin","type":"address"},{"name":"_token","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_addr","type":"address"}],"name":"SetCoinAddress","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_addr","type":"address"}],"name":"SetTokenAddress","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_sender","type":"address"},{"indexed":false,"name":"_productId","type":"uint256"}],"name":"RegisterServiceProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"},{"indexed":false,"name":"_buyer","type":"address"},{"indexed":false,"name":"_amount","type":"uint256"},{"indexed":false,"name":"_price","type":"uint256"}],"name":"PurchaseServiceProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_sender","type":"address"},{"indexed":false,"name":"_productId","type":"uint256"}],"name":"RegisterUserProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"},{"indexed":false,"name":"_buyer","type":"address"},{"indexed":false,"name":"_tokenId","type":"uint256"},{"indexed":false,"name":"_amount","type":"uint256"},{"indexed":false,"name":"_price","type":"uint256"}],"name":"PurchaseUserProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"}],"name":"CancelServiceProductSale","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"}],"name":"CancelUserProductSale","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"previousOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"setCoinAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getCoinAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"setTokenAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getTokenAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfValidServiceProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfAllServiceProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfValidUserProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfAllUserProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_productId","type":"uint256"}],"name":"ownerOfUserProduct","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_totalAmount","type":"uint256"},{"name":"_perPrice","type":"uint256"}],"name":"registerServiceProduct","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_amount","type":"uint256"},{"name":"_price","type":"uint256"}],"name":"registerUserProduct","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getValidServiceProductAll","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"totalAmount","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"perPrice","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"lastProductId","type":"uint256"},{"name":"count","type":"uint256"}],"name":"getValidServiceProducts","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"totalAmount","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"perPrice","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getValidUserProductAll","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"lastProductId","type":"uint256"},{"name":"count","type":"uint256"}],"name":"getValidUserProducts","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"getValidUserProductsOwned","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getAllServiceProducts","outputs":[{"components":[{"name":"productId","type":"uint256"},{"name":"owner","type":"address"},{"name":"tokenId","type":"uint256"},{"name":"totalAmount","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"perPrice","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"}],"name":"cancelServiceProductSale","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"},{"name":"_owner","type":"address"}],"name":"cancelUserProductSale","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"},{"name":"_buyer","type":"address"},{"name":"_amount","type":"uint256"}],"name":"purchaseServiceProduct","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"},{"name":"_buyer","type":"address"}],"name":"purchaseUserProduct","outputs":[],"payable":true,"stateMutability":"payable","type":"function"}];


var tradeAddress = '0x783e3AE7fbABa3B2291C8910775AF86558B2fc34';
var tradeABI =
[{"constant":true,"inputs":[],"name":"tokenContract","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isOwner","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"allTradeProducts","outputs":[{"name":"tradeId","type":"uint256"},{"name":"owner","type":"address"},{"name":"timestamp","type":"uint256"},{"name":"isValid","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"validTradeProductIds","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_token","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_addr","type":"address"}],"name":"SetTokenAddress","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_owner","type":"address"},{"indexed":false,"name":"_productId","type":"uint256"}],"name":"RegisterTradeProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"},{"indexed":false,"name":"_requester","type":"address"}],"name":"ConfirmTradeProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_productId","type":"uint256"},{"indexed":false,"name":"_requester","type":"address"}],"name":"CancelTradeProduct","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"previousOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"setTokenAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getTokenAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfValidTradeProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"countOfAllTradeProducts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_productId","type":"uint256"}],"name":"ownerOfTradeProduct","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_offerTokenIds","type":"uint256[]"},{"name":"_offerTokenAmounts","type":"uint256[]"},{"name":"_requiredTokenIds","type":"uint256[]"},{"name":"_requiredTokenAmounts","type":"uint256[]"}],"name":"registerTradeProduct","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getValidTradeProductAll","outputs":[{"components":[{"name":"tradeId","type":"uint256"},{"name":"owner","type":"address"},{"name":"offerTokenIds","type":"uint256[]"},{"name":"offerTokenAmounts","type":"uint256[]"},{"name":"requiredTokenIds","type":"uint256[]"},{"name":"requiredTokenAmounts","type":"uint256[]"},{"name":"timestamp","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"lastProductId","type":"uint256"},{"name":"count","type":"uint256"}],"name":"getValidTradeProducts","outputs":[{"components":[{"name":"tradeId","type":"uint256"},{"name":"owner","type":"address"},{"name":"offerTokenIds","type":"uint256[]"},{"name":"offerTokenAmounts","type":"uint256[]"},{"name":"requiredTokenIds","type":"uint256[]"},{"name":"requiredTokenAmounts","type":"uint256[]"},{"name":"timestamp","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"getValidTradeProductsOwned","outputs":[{"components":[{"name":"tradeId","type":"uint256"},{"name":"owner","type":"address"},{"name":"offerTokenIds","type":"uint256[]"},{"name":"offerTokenAmounts","type":"uint256[]"},{"name":"requiredTokenIds","type":"uint256[]"},{"name":"requiredTokenAmounts","type":"uint256[]"},{"name":"timestamp","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getAllTradeProducts","outputs":[{"components":[{"name":"tradeId","type":"uint256"},{"name":"owner","type":"address"},{"name":"offerTokenIds","type":"uint256[]"},{"name":"offerTokenAmounts","type":"uint256[]"},{"name":"requiredTokenIds","type":"uint256[]"},{"name":"requiredTokenAmounts","type":"uint256[]"},{"name":"timestamp","type":"uint256"},{"name":"isValid","type":"bool"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"},{"name":"_owner","type":"address"}],"name":"cancelTradeProduct","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_productId","type":"uint256"},{"name":"_requester","type":"address"}],"name":"confirmTradeProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];

var coinContract =  new ethers.Contract(coinAddress,coinABI,wallet);
var tokenContract = new ethers.Contract(tokenAddress,tokenABI,wallet);
var marketContract = new ethers.Contract(marketAddress,marketABI,wallet);
var tradeContract = new ethers.Contract(tradeAddress,tradeABI,wallet);



    let iface = new ethers.utils.Interface(coinABI);

    let coinFilter = tokenContract.filters.Transfer(null, null);
    var latesBlockNumber = provider.getBlockNumber();
    latesBlockNumber.then(function(blockNumber) {
        console.log("block number: " + blockNumber);

    let coinFilter = coinContract.filters.Transfer(null, null);

    // var filter = {
    //     address: coinContract.address,
    //     fromBlock: blockNumber-20,
    //     toBlock: blockNumber,
    //     topics: coinFilter.topics
    // };

    var filter = {
      address: coinContract.address,
      topics:
      [ '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef' ]
    }

    console.log(coinFilter);

    var callPromise = provider.getLogs(filter);
    callPromise.then(function(logs) {
        console.log("Printing array of events:");
        let events = logs.map((log) => iface.parseLog(log))
        console.log(events);
        console.log(logs);
    }).catch(function(err){
        console.log(err);
    });
});


var tx = await coinContract.sendCoin("0x68258d49038A33cb0969D4d2e8f89946800073af", "0x11D44a2dF37fB30ecb3D481de4b9416e8A3CB0bb", 10, "test");
console.log("---", tx);



var callOwnerPromise = coinContract.balanceOf("0x68258d49038A33cb0969D4d2e8f89946800073af");
 callOwnerPromise.then(function(result) {
   console.log(result);
 });

let sendCoinFilter = coinContract.filters.SendCoin(null, null, null, null);
 coinContract.on(sendCoinFilter, (from, to, value, memo, event) => {
   console.log("SendCoin---------------------- \n", event);
});

 let purchaseCoinFilter = coinContract.filters.PurchaseCoin(null, null, null, null, null);
  coinContract.on(purchaseCoinFilter, (from, to, value, purchaseId, memo, event) => {
    console.log("PurchaseCoin---------------------- \n", event);
});

  let rewardCoinFilter = coinContract.filters.RewardCoin(null, null, null, null);
   coinContract.on(rewardCoinFilter, (from, to, value, memo, event) => {
     console.log("RewardCoin---------------------- \n", event);
});

   let burnCoinFilter = coinContract.filters.BurnCoin(null, null, null, null);
    coinContract.on(burnCoinFilter, (from, to, value, memo, event) => {
      console.log("BurnCoin---------------------- \n", event);
    });

    //--------------------

    let newMarketAddressFilter = tokenContract.filters.NewMarketAddress(null);
     tokenContract.on(newMarketAddressFilter, (address, event) => {
       console.log("NewMarketAddress---------------------- \n", event);
    });

    let newTradeAddressFilter = tokenContract.filters.NewTradeAddress(null);
     tokenContract.on(newTradeAddressFilter, (address, event) => {
       console.log("NewTradeAddress---------------------- \n", event);
    });

    let newBaseTokenURIFilter = tokenContract.filters.NewBaseTokenURI(null);
     tokenContract.on(newBaseTokenURIFilter, (address, event) => {
       console.log("NewBaseTokenURI---------------------- \n", event);
    });


    let transferWithQuantityFilter = tokenContract.filters.TransferWithQuantity(null, null, null, null);
     tokenContract.on(transferWithQuantityFilter, (from, to, tokenId, quantity, event) => {
       console.log("TransferWithQuantity---------------------- \n", event);
    });

    let batchTransferFilter = tokenContract.filters.BatchTransfer(null, null, null, null);
     tokenContract.on(batchTransferFilter, (from, to, tokenTypes, amounts, event) => {
       console.log("BatchTransferFilter---------------------- \n", event);
    });


    let registerServiceProductFilter = marketContract.filters.RegisterServiceProduct(null, null);
    marketContract.on(registerServiceProductFilter, (owner, productId, event) => {
      console.log("RegisterServiceProduct---------------------- \n", event);
    });

    let registerUserProductFilter = marketContract.filters.RegisterUserProduct(null, null);
    marketContract.on(registerUserProductFilter, (owner, productId, event) => {
      console.log("RegisterUserProduct---------------------- \n", event);
    });

    // ------------------------------

    let regiserTradeProductFilter = tradeContract.filters.RegisterTradeProduct(null, null);
    tradeContract.on(regiserTradeProductFilter, (owner, productId, event) => {
      console.log("RegisterTradeProduct---------------------- \n", event);
    });


    let confirmTradeProductFilter = tradeContract.filters.ConfirmTradeProduct(null, null);
    tradeContract.on(confirmTradeProductFilter, (productId, requester, event) => {
      console.log("ConfirmTradeProduct---------------------- \n", event);
    });


    let cancelTradeProductFilter = tradeContract.filters.CancelTradeProduct(null);
    tradeContract.on(cancelTradeProductFilter, (productId, event) => {
      console.log("CancelTradeProduct---------------------- \n", event);
    });
